version: "3.7"

services:
  
  postgres:
    image: postgres
    environment:
      POSTGRES_PASSWORD: speakypass
      POSTGRES_USER: speaky
      POSTGRES_DB: speakydb
    volumes:
      - db_data:/var/lib/postgresql/data
      - ./test_data:/test_data
    ports:
      - "127.0.0.1:5432:5432"

  speaky-bot:
    build:
      context: .
    image: speaky-django:latest
    environment:
      DJANGO_SECRET_KEY: "arfdgvds"
      DJ_DEBUG: "False"
      TG_TOKEN: ""
      
    depends_on:
      - postgres

    command:
      - sh
      - -c
      - |
        python manage.py async_bot

  speaky-admin:
    build:
      context: .
    image: speaky-django:latest
    ports:
      - 8000
    volumes:
      - ./nginx-templates:/app/nginx-templates
      - nginx_assets:/app/assets/
      - nginx_media:/var/www/media/
    environment:
      DJANGO_SECRET_KEY: "arfdgvds"
      DJ_DEBUG: "True"
      DJ_ALLOWED_HOSTS: '127.0.0.1,localhost'
      DJ_CSRF_TRUSTED_ORIGINS: 'http://127.0.0.1:8000'
      DJ_DB_URL: 'postgres://speaky:speakypass@postgres:5432/speakydb'
      MEDIA_ROOT: '/var/www/media'
      
    depends_on:
      - postgres

    command:
      - sh
      - -c
      - |
        python manage.py collectstatic --noinput
        python manage.py runserver 0.0.0.0:8000 --noreload

  nginx:
    image: nginx
    ports:
      - 127.0.0.1:8000:80
    environment:
      UPSTREAM_SERVER: speaky-admin:8000
    volumes:
      - ./nginx-templates:/etc/nginx/templates/
      - nginx_assets:/var/www/static/
      - nginx_media:/var/www/media/
    depends_on:
      - speaky-admin



volumes:
  db_data:
  nginx_media:
  nginx_assets:
